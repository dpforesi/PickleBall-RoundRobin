<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pickleball Round Robin Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #controls { margin-bottom: 20px; }
    textarea { width: 100%; }
    input, button { margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    @media print { #controls { display: none; } }
  </style>
</head>
<body>
  <div id="controls">
    <h2>Pickleball Round Robin Generator</h2>
    <textarea id="players" rows="8" placeholder="One player per line"></textarea><br>
    Max Courts: <input id="maxCourts" type="number" value="4" min="1">
    Rounds: <input id="rounds" type="number" value="3" min="1"><br>
    <button onclick="generate()">Generate</button>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="exportExcel()">Export Excel</button>
    <button onclick="window.print()">Print</button>
  </div>
  <div id="output"></div>

  <script>
    let csvContent = '';

    // Add a helper function to shuffle an array using Fisher-Yates algorithm
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generate() {
      // Read inputs
      const names = document.getElementById('players').value
        .trim().split(/\r?\n/).filter(n => n);
      const maxCourts = +document.getElementById('maxCourts').value;
      const roundsInput = +document.getElementById('rounds').value;
      if (names.length < 2) {
        document.getElementById('output').innerHTML = '<p>Enter at least two players.</p>';
        return;
      }

      // Prepare circle method
      // Randomize players list before proceeding
      const players = shuffle(names.slice());
      if (players.length % 2 === 1) players.push('BYE');
      const totalRounds = players.length - 1;
      const roundsToUse = Math.min(roundsInput, totalRounds);
      let circle = players.slice();

      let html = '';
      let csv = '';

      for (let r = 0; r < roundsToUse; r++) {
        // build pairs
        const pairs = [];
        const benchedList = [];
        const half = circle.length / 2;
        for (let i = 0; i < half; i++) {
          const p1 = circle[i];
          const p2 = circle[circle.length - 1 - i];
          if (p1 === 'BYE' && p2 !== 'BYE') {
            benchedList.push(p2);
          } else if (p2 === 'BYE' && p1 !== 'BYE') {
            benchedList.push(p1);
          } else if (p1 !== 'BYE' && p2 !== 'BYE') {
            pairs.push([p1, p2]);
          }
        }

        // header
        html += `<h3>Round ${r + 1}</h3>
          <table>
            <tr><th class="court">Court</th><th>Team 1</th><th>Team 2</th></tr>`;
        csv += `Round ${r + 1}\nCourt,Team 1,Team 2\n`;

        // assign to courts
        const courtsThisRound = Math.floor(pairs.length / 2);
        for (let c = 0; c < courtsThisRound; c++) {
          const team1 = pairs.shift();
          const team2 = pairs.shift();
          html += `<tr>
              <td class="court">${c + 1}</td>
              <td>${team1.join(' --- ')}</td>
              <td>${team2.join(' --- ')}</td>
            </tr>`;
          csv += `${c + 1},"${team1.join(', ')}","${team2.join(', ')}"\n`;
        }

        // bench leftovers
        const leftover = pairs.flat();
        const benched = benchedList.concat(leftover);
        if (benched.length) {
          html += `<tr><td colspan="3">Benched: ${benched.join(', ')}</td></tr>`;
          csv += `Benched,,,"${benched.join(', ')}"\n`;
        }

        html += '</table>\n';
        csv += '\n';

        // rotate circle
        circle = [
          circle[0],
          circle[circle.length - 1],
          ...circle.slice(1, circle.length - 1)
        ];
      }

      // render and store
      document.getElementById('output').innerHTML = html;
      csvContent = csv;
      fixColumnWidths();
    }

    // This function adjusts the team cells so they all get the width of the widest one.
    // It also fixes the court cell width.
    function fixColumnWidths() {
      const tables = document.querySelectorAll('#output table');
      tables.forEach(table => {
        let maxWidth = 0;
        const teamCells = table.querySelectorAll('td:nth-child(2), td:nth-child(3)');
        teamCells.forEach(cell => {
          const width = cell.scrollWidth;
          if (width > maxWidth) maxWidth = width;
        });
        // Set width for each team cell to the maximum width found.
        teamCells.forEach(cell => cell.style.width = maxWidth + 'px');
        // Make the court cells smaller.
        const courtCells = table.querySelectorAll('td.court');
        courtCells.forEach(cell => cell.style.width = '50px');
      });
    }

    function exportCSV() {
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'round_robin.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportExcel() {
      // Get the output (tables HTML)
      const htmlTable = document.getElementById('output').innerHTML;
      const excelHTML = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:x="urn:schemas-microsoft-com:office:excel" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <!--[if gte mso 9]><xml>
          <x:ExcelWorkbook>
            <x:ExcelWorksheets>
              <x:ExcelWorksheet>
                <x:Name>Sheet1</x:Name>
                <x:WorksheetOptions>
                  <x:Print>
                    <x:ValidPrinterInfo/>
                  </x:Print>
                </x:WorksheetOptions>
              </x:ExcelWorksheet>
            </x:ExcelWorksheets>
          </x:ExcelWorkbook>
          </xml><![endif]-->
          <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        </head>
        <body>
          ${htmlTable}
        </body>
        </html>`;
      const blob = new Blob([excelHTML], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'round_robin.xls';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
